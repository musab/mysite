<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="Sharing with others, hoping it will help someone else someday.
The task was to generate Ed25519 specific SSH keypairs in Go for the purpose of being used as deploy keys.
Using ssh-keygen gets you a PEM-encoded private key and a correctly encoded public key. You don&rsquo;t get the same when using the crypto/ed25519 package.
Let us begin by first correctly encoding the public key.
type Key struct {
	PublicKey                ed25519.PublicKey
	PrivateKey               ed25519.PrivateKey
	PublicKeyEncodedToString string
}

func GenerateEd25519Keys() (*Key, error) {

	const sshAlgoType = &#34;ssh-ed25519&#34;

	pubKey, privKey, err := ed25519.GenerateKey(rand.Reader)


	pubPublicKey, err := ssh.NewPublicKey(pubKey)

  // pubPublicKey is not encoded in the correct format a typical VCS requires.
  //  - does not include the `ssh-ed25519` prefix
  // Here we prefix the public key with the algorithm type.
	sshPubKey := sshAlgoType &#43; &#34; &#34; &#43; base64.StdEncoding.EncodeToString(pubPublicKey.Marshal())

	return &amp;Key{
		PublicKey:                pubKey,
		PublicKeyEncodedToString: sshPubKey,
		PrivateKey:               privKey,
	}, nil
}
Next, we PEM encode the private key. This is the same as the private key generated by ssh-keygen.">  

  <title>
    
      generating ed25519 ssh deploy keys in Go
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  
  
  
  <link rel="stylesheet" href="//localhost:1313/css/main.01273a70fa873b012d056499c16bb47955e0e7526c34edb73f05ca8f99f488ebc323423c6557f93f9b42a41de0448a25ce9a1ab577d0bf61e36eaf52a4979a1d.css" integrity="sha512-ASc6cPqHOwEtBWSZwWu0eVXg51JsNO23PwXKj5n0iOvDI0I8ZVf5P5tCpB3gRIolzpoatXfQv2Hjbq9SpJeaHQ==" />
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
<a href="/">..</a>


<article>
    <p class="post-meta">
        <time datetime="2022-04-05 16:40:29 &#43;0900 JST">
            2022-04-05
        </time>
    </p>

    <h1>generating ed25519 ssh deploy keys in Go</h1>

    

    <p>Sharing with others, hoping it will help someone else someday.</p>
<p>The task was to generate Ed25519 specific SSH keypairs in Go for the purpose of being used as deploy keys.</p>
<p>Using <code>ssh-keygen</code> gets you a PEM-encoded private key and a correctly encoded public key. You don&rsquo;t get the same when using the <a href="https://pkg.go.dev/crypto/ed25519">crypto/ed25519</a> package.</p>
<p>Let us begin by first correctly encoding the public key.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f00">type</span> Key <span style="color:#f00">struct</span> {
</span></span><span style="display:flex;"><span>	PublicKey                ed25519.PublicKey
</span></span><span style="display:flex;"><span>	PrivateKey               ed25519.PrivateKey
</span></span><span style="display:flex;"><span>	PublicKeyEncodedToString <span style="color:#ee82ee">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">func</span> <span style="color:#ff0">GenerateEd25519Keys</span>() (*Key, <span style="color:#ee82ee">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f00">const</span> sshAlgoType = <span style="color:#87ceeb">&#34;ssh-ed25519&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pubKey, privKey, err := ed25519.<span style="color:#ff0">GenerateKey</span>(rand.Reader)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pubPublicKey, err := ssh.<span style="color:#ff0">NewPublicKey</span>(pubKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#0f0">// pubPublicKey is not encoded in the correct format a typical VCS requires.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0f0">//  - does not include the `ssh-ed25519` prefix</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0f0">// Here we prefix the public key with the algorithm type.</span>
</span></span><span style="display:flex;"><span>	sshPubKey := sshAlgoType + <span style="color:#87ceeb">&#34; &#34;</span> + base64.StdEncoding.<span style="color:#ff0">EncodeToString</span>(pubPublicKey.<span style="color:#ff0">Marshal</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f00">return</span> &amp;Key{
</span></span><span style="display:flex;"><span>		PublicKey:                pubKey,
</span></span><span style="display:flex;"><span>		PublicKeyEncodedToString: sshPubKey,
</span></span><span style="display:flex;"><span>		PrivateKey:               privKey,
</span></span><span style="display:flex;"><span>	}, <span style="color:#f00">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next, we PEM encode the private key. This is the same as the private key generated by <code>ssh-keygen</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f00">func</span> <span style="color:#ff0">PrivateKeyToPEM</span>(privKey ed25519.PrivateKey) ([]<span style="color:#ee82ee">byte</span>, <span style="color:#ee82ee">error</span>) {
</span></span><span style="display:flex;"><span>	keybytes, _ := x509.<span style="color:#ff0">MarshalPKCS8PrivateKey</span>(privKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	keyBuf := &amp;bytes.Buffer{}
</span></span><span style="display:flex;"><span>	err := pem.<span style="color:#ff0">Encode</span>(keyBuf, &amp;pem.Block{Type: <span style="color:#87ceeb">&#34;PRIVATE KEY&#34;</span>, Bytes: keybytes})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f00">return</span> keyBuf.<span style="color:#ff0">Bytes</span>(), err
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Play with this code via <a href="https://go.dev/play/p/9tMbZ7umzFq">Go Playground</a>.</p>

</article>

            </div>
        </main>
    </body></html>
